version: '3.9'

# Complete CoLink Platform - All Services
# This compose file includes infrastructure and all backend microservices

services:
  # ============================================================================
  # Infrastructure Services
  # ============================================================================

  # PostgreSQL - Primary database
  postgres:
    image: postgres:15-alpine
    container_name: colink-postgres
    environment:
      POSTGRES_DB: colink
      POSTGRES_USER: colink
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-colink_dev_password}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U colink"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - colink-network

  # MongoDB - File metadata and audit logs
  mongodb:
    image: mongo:6
    container_name: colink-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: colink
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_PASSWORD:-colink_dev_password}
    ports:
      - "${MONGODB_PORT:-27017}:27017"
    volumes:
      - mongodb_data:/data/db
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/colink --quiet
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - colink-network

  # Redis - Caching and presence
  redis:
    image: redis:7-alpine
    container_name: colink-redis
    command: redis-server --requirepass ${REDIS_PASSWORD:-colink_dev_password}
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-colink_dev_password}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - colink-network

  # Kafka - Event streaming
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: colink-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    volumes:
      - zookeeper_data:/var/lib/zookeeper/data
    networks:
      - colink-network

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: colink-kafka
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    ports:
      - "${KAFKA_PORT:-9092}:9092"
      - "29092:29092"
    volumes:
      - kafka_data:/var/lib/kafka/data
    networks:
      - colink-network

  # Keycloak - SSO
  keycloak:
    image: quay.io/keycloak/keycloak:23.0
    container_name: colink-keycloak
    command: start-dev
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak
      KC_DB_USERNAME: colink
      KC_DB_PASSWORD: ${POSTGRES_PASSWORD:-colink_dev_password}
      KC_HTTP_ENABLED: "true"
    ports:
      - "${KEYCLOAK_PORT:-8080}:8080"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - colink-network

  # LocalStack - AWS S3 emulation
  localstack:
    image: localstack/localstack:3.0
    container_name: colink-localstack
    environment:
      SERVICES: s3
      AWS_DEFAULT_REGION: us-east-1
      EDGE_PORT: 4566
    ports:
      - "4566:4566"
    volumes:
      - localstack_data:/var/lib/localstack
    networks:
      - colink-network

  # ============================================================================
  # CoLink Backend Microservices
  # ============================================================================

  # Users Service - User profiles and authentication
  users:
    build:
      context: .
      dockerfile: services/users/Dockerfile
    container_name: colink-users
    ports:
      - "8001:8001"
    environment:
      POSTGRES_URL: postgresql://colink:${POSTGRES_PASSWORD:-colink_dev_password}@postgres:5432/colink
      KEYCLOAK_URL: http://keycloak:8080
      KEYCLOAK_REALM: colink
      REDIS_URL: redis://:${REDIS_PASSWORD:-colink_dev_password}@redis:6379/0
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      keycloak:
        condition: service_started
    networks:
      - colink-network

  # Messaging Service - Messages, threads, reactions
  messaging:
    build:
      context: .
      dockerfile: services/messaging/Dockerfile
    container_name: colink-messaging
    ports:
      - "8002:8002"
    environment:
      POSTGRES_URL: postgresql://colink:${POSTGRES_PASSWORD:-colink_dev_password}@postgres:5432/colink
      KEYCLOAK_URL: http://keycloak:8080
      KEYCLOAK_REALM: colink
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_started
      keycloak:
        condition: service_started
    networks:
      - colink-network

  # Files Service - File upload/download
  files:
    build:
      context: .
      dockerfile: services/files/Dockerfile
    container_name: colink-files
    ports:
      - "8003:8003"
    environment:
      MONGODB_URL: mongodb://colink:${MONGODB_PASSWORD:-colink_dev_password}@mongodb:27017/colink
      KEYCLOAK_URL: http://keycloak:8080
      KEYCLOAK_REALM: colink
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      S3_ENDPOINT_URL: http://localstack:4566
      S3_BUCKET: colink-files
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
    depends_on:
      mongodb:
        condition: service_healthy
      localstack:
        condition: service_started
      kafka:
        condition: service_started
    networks:
      - colink-network

  # Search Service - Full-text search
  search:
    build:
      context: .
      dockerfile: services/search/Dockerfile
    container_name: colink-search
    ports:
      - "8004:8004"
    environment:
      POSTGRES_URL: postgresql://colink:${POSTGRES_PASSWORD:-colink_dev_password}@postgres:5432/colink
      MONGODB_URL: mongodb://colink:${MONGODB_PASSWORD:-colink_dev_password}@mongodb:27017/colink
      KEYCLOAK_URL: http://keycloak:8080
      KEYCLOAK_REALM: colink
    depends_on:
      postgres:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    networks:
      - colink-network

  # Admin Service - Administration and moderation
  admin:
    build:
      context: .
      dockerfile: services/admin/Dockerfile
    container_name: colink-admin
    ports:
      - "8005:8005"
    environment:
      MONGODB_URL: mongodb://colink:${MONGODB_PASSWORD:-colink_dev_password}@mongodb:27017/colink
      KEYCLOAK_URL: http://keycloak:8080
      KEYCLOAK_REALM: colink
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      USERS_SERVICE_URL: http://users:8001
      MESSAGING_SERVICE_URL: http://messaging:8002
    depends_on:
      mongodb:
        condition: service_healthy
      kafka:
        condition: service_started
    networks:
      - colink-network

  # Channels Service - Channels and DMs
  channels:
    build:
      context: .
      dockerfile: services/channels/Dockerfile
    container_name: colink-channels
    ports:
      - "8006:8006"
    environment:
      POSTGRES_URL: postgresql://colink:${POSTGRES_PASSWORD:-colink_dev_password}@postgres:5432/colink
      KEYCLOAK_URL: http://keycloak:8080
      KEYCLOAK_REALM: colink
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_started
    networks:
      - colink-network

  # Gateway Service - WebSocket and API Gateway
  gateway:
    build:
      context: .
      dockerfile: services/gateway/Dockerfile
    container_name: colink-gateway
    ports:
      - "8007:8007"
    environment:
      REDIS_URL: redis://:${REDIS_PASSWORD:-colink_dev_password}@redis:6379/0
      KEYCLOAK_URL: http://keycloak:8080
      KEYCLOAK_REALM: colink
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - colink-network

  # Presence Service - Online status and typing
  presence:
    build:
      context: .
      dockerfile: services/presence/Dockerfile
    container_name: colink-presence
    ports:
      - "8008:8008"
    environment:
      REDIS_URL: redis://:${REDIS_PASSWORD:-colink_dev_password}@redis:6379/0
      KEYCLOAK_URL: http://keycloak:8080
      KEYCLOAK_REALM: colink
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - colink-network

volumes:
  postgres_data:
  mongodb_data:
  redis_data:
  kafka_data:
  zookeeper_data:
  localstack_data:

networks:
  colink-network:
    driver: bridge
    name: colink-network
