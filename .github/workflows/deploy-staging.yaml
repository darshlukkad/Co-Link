name: Deploy to Staging

on:
  push:
    branches: [ master ]
  workflow_dispatch:

env:
  K8S_NAMESPACE: colink-staging
  ENVIRONMENT: staging

jobs:
  deploy:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://staging.colink.io

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --name colink-staging-cluster \
            --region us-east-1

      - name: Install Kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Update image tags
        working-directory: infra/k8s/overlays/staging
        run: |
          kustomize edit set image \
            colink/users-service=ghcr.io/${{ github.repository_owner }}/colink-users:${{ github.sha }} \
            colink/messaging-service=ghcr.io/${{ github.repository_owner }}/colink-messaging:${{ github.sha }} \
            colink/files-service=ghcr.io/${{ github.repository_owner }}/colink-files:${{ github.sha }} \
            colink/search-service=ghcr.io/${{ github.repository_owner }}/colink-search:${{ github.sha }} \
            colink/admin-service=ghcr.io/${{ github.repository_owner }}/colink-admin:${{ github.sha }} \
            colink/channels-service=ghcr.io/${{ github.repository_owner }}/colink-channels:${{ github.sha }} \
            colink/gateway-service=ghcr.io/${{ github.repository_owner }}/colink-gateway:${{ github.sha }} \
            colink/presence-service=ghcr.io/${{ github.repository_owner }}/colink-presence:${{ github.sha }}

      - name: Deploy to Kubernetes
        run: |
          kustomize build infra/k8s/overlays/staging | kubectl apply -f -

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/staging-users-service -n ${{ env.K8S_NAMESPACE }} --timeout=10m
          kubectl rollout status deployment/staging-messaging-service -n ${{ env.K8S_NAMESPACE }} --timeout=10m
          kubectl rollout status deployment/staging-gateway-service -n ${{ env.K8S_NAMESPACE }} --timeout=10m
          kubectl rollout status deployment/staging-channels-service -n ${{ env.K8S_NAMESPACE }} --timeout=10m

      - name: Run integration tests
        run: |
          # Wait for all services to be fully ready
          sleep 60

          # Run comprehensive integration tests
          kubectl run integration-test \
            --image=python:3.11-slim \
            --rm -i --restart=Never \
            -n ${{ env.K8S_NAMESPACE }} \
            -- bash -c "
              pip install httpx pytest pytest-asyncio &&
              python -m pytest /tests/integration -v
            "

      - name: Notify deployment status
        if: always()
        run: |
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "Deployment to staging successful"
          else
            echo "Deployment to staging failed"
            exit 1
          fi
