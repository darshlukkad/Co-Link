name: Lint

on:
  push:
    branches: ["master", "develop", "claude/**"]
  pull_request:
    branches: ["master", "develop"]

jobs:
  lint-python:
    name: Lint Python Code
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff black isort mypy

      - name: Lint with ruff
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          ruff check services/ --select=E9,F63,F7,F82 --target-version=py311
          # Exit-zero treats all errors as warnings
          ruff check services/ --exit-zero --target-version=py311

      - name: Check formatting with black
        run: |
          black --check --diff services/

      - name: Check import sorting with isort
        run: |
          isort --check-only --diff services/

      - name: Type check with mypy (optional, will warn but not fail)
        continue-on-error: true
        run: |
          mypy services/ --ignore-missing-imports --no-strict-optional || true

  lint-frontend:
    name: Lint Frontend Code
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: ["20"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Lint with ESLint
        working-directory: frontend
        run: npm run lint || echo "ESLint not configured yet"

      - name: Check formatting with Prettier
        working-directory: frontend
        run: npm run format:check || echo "Prettier not configured yet"

      - name: Type check with TypeScript
        working-directory: frontend
        run: npm run type-check || echo "TypeScript check not configured yet"

  lint-yaml:
    name: Lint YAML Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install yamllint
        run: pip install yamllint

      - name: Lint YAML files
        run: |
          yamllint -d "{extends: default, rules: {line-length: {max: 120}}}" \
            docker-compose.dev.yml \
            .github/workflows/ \
            infra/k8s/ || echo "YAML linting warnings found"

  lint-docker:
    name: Lint Dockerfiles
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: "services/*/Dockerfile"
          recursive: true
          failure-threshold: warning
        continue-on-error: true

  lint-markdown:
    name: Lint Markdown Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Lint Markdown
        uses: articulate/actions-markdownlint@v1
        with:
          config: .markdownlint.json
          files: '**/*.md'
          ignore: node_modules
        continue-on-error: true

  lint-shell:
    name: Lint Shell Scripts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'
          severity: warning
        continue-on-error: true

  summary:
    name: Lint Summary
    runs-on: ubuntu-latest
    needs: [lint-python, lint-frontend, lint-yaml, lint-docker, lint-markdown, lint-shell]
    if: always()

    steps:
      - name: Check lint results
        run: |
          echo "Lint checks completed!"
          echo "Python lint: ${{ needs.lint-python.result }}"
          echo "Frontend lint: ${{ needs.lint-frontend.result }}"
          echo "YAML lint: ${{ needs.lint-yaml.result }}"
          echo "Docker lint: ${{ needs.lint-docker.result }}"
          echo "Markdown lint: ${{ needs.lint-markdown.result }}"
          echo "Shell lint: ${{ needs.lint-shell.result }}"
